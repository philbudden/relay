# Samba SMB/CIFS File Sharing Service
# Managed by Relay - Do not edit manually
# Generated from: roles/samba/templates/samba.container.j2

[Unit]
Description=Samba SMB/CIFS file sharing service
Documentation=https://github.com/dperson/samba
After=network-online.target mnt-ssd.mount mnt-backup.mount
Wants=network-online.target
Requires=mnt-ssd.mount mnt-backup.mount

[Container]
Image={{ samba_full_image }}
ContainerName=samba
AutoUpdate=registry

# Host networking for SMB ports (445, 139, 137-138)
Network=host

# Volume mounts
# Config and cache directories
Volume={{ samba_config_dir }}:/config:Z
Volume={{ samba_cache_dir }}:/cache:Z

# Share directories (organized subdirectories, not raw mounts)
# Read-only shares are mounted with :ro flag for defense in depth
{% for share in samba_shares %}
Volume={{ share.path }}:/shares/{{ share.name }}:{% if share.readonly == 'yes' %}ro,Z{% else %}Z{% endif %}

{% endfor %}

# Environment variables for dperson/samba container
# User configuration
{% for user in samba_users %}
Environment=USER={{ user.username }};{{ user.password }}{% if user.uid is defined %};{{ user.uid }}{% endif %}{% if user.gid is defined %};{{ user.gid }}{% endif %}

{% endfor %}

# Share configuration
{% for share in samba_shares %}
Environment=SHARE={{ share.name }};/shares/{{ share.name }};{{ share.browseable }};{{ share.readonly }};{{ share.guest }};{{ share.users }};{{ share.users }};{{ share.comment }}
{% endfor %}

# Global Samba configuration
Environment=WORKGROUP={{ samba_workgroup }}
Environment=TZ={{ samba_timezone }}
{% if samba_recycle_bin %}
Environment=RECYCLE=true
{% endif %}

# Security context - use default container_t instead of overly permissive spc_t
SecurityLabelDisable=false

# Capabilities (minimal required for Samba to bind to privileged ports and manage users)
AddCapability=CAP_NET_BIND_SERVICE
AddCapability=CAP_SETUID
AddCapability=CAP_SETGID

# Health check (verify Samba is responding)
HealthCmd=/usr/bin/smbstatus || exit 1
HealthInterval=30s
HealthStartPeriod=60s

# Resource limits (optional)
{% if samba_memory_limit %}
Memory={{ samba_memory_limit }}
{% endif %}
{% if samba_cpu_shares %}
CPUShares={{ samba_cpu_shares }}
{% endif %}

[Service]
Restart={{ samba_restart_policy }}
RestartSec={{ samba_restart_sec }}
TimeoutStartSec={{ samba_timeout_start_sec }}

[Install]
WantedBy=multi-user.target
